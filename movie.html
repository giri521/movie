<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watch Together</title>
  <style>
    body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; margin:0; padding:0; }
    #app { display: flex; flex-direction: row; margin-top: 20px; gap: 20px; }
    #video-chat, #movie-player, #chat { border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
    video { width: 300px; height: 200px; background: black; }
    #messages { height: 200px; width: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-bottom: 5px; }
    input { width: 200px; }
  </style>
</head>
<body>
  <h2>Watch Together (Long Distance Couples)</h2>

  <div>
    <input id="username" placeholder="Enter username">
    <button id="loginBtn">Login / Signup</button>
  </div>

  <div id="roomSection" style="display:none;">
    <input id="roomInput" placeholder="Enter room code">
    <button id="createRoomBtn">Create Room</button>
    <button id="joinRoomBtn">Join Room</button>
  </div>

  <div id="app" style="display:none;">
    <div id="video-chat">
      <h3>Video Chat</h3>
      <video id="localVideo" autoplay muted></video>
      <video id="remoteVideo" autoplay></video>
    </div>

    <div id="movie-player">
      <h3>Movie</h3>
      <video id="movie" width="400" controls>
        <source src="movie.mp4" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>
      <br>
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
    </div>

    <div id="chat">
      <h3>Chat</h3>
      <div id="messages"></div>
      <input type="text" id="msgInput" placeholder="Type message">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script src="https://cdn.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <script>
    // Initialize Backendless
    const APP_ID = '175B6549-0AFE-41E3-BBEA-5FDB51825200';
    const API_KEY = 'D3301207-E860-4214-BEA5-910123DFEAD7';
    Backendless.initApp(APP_ID, API_KEY);

    let currentUser = null;
    let currentRoom = null;

    const loginBtn = document.getElementById("loginBtn");
    const usernameInput = document.getElementById("username");
    const roomSection = document.getElementById("roomSection");
    const appDiv = document.getElementById("app");
    const roomInput = document.getElementById("roomInput");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const joinRoomBtn = document.getElementById("joinRoomBtn");

    // Login / Signup
    loginBtn.onclick = async () => {
      const username = usernameInput.value.trim();
      if(!username) return alert("Enter username!");
      try {
        let user = await Backendless.UserService.login(username, "1234");
        currentUser = user;
      } catch(e) {
        // If login fails, create user
        let user = new Backendless.User();
        user.username = username;
        user.password = "1234";
        currentUser = await Backendless.UserService.register(user);
      }
      alert("Logged in as " + username);
      roomSection.style.display = "block";
    };

    // Create / Join Room
    createRoomBtn.onclick = async () => {
      const roomCode = roomInput.value.trim();
      if(!roomCode) return alert("Enter room code!");
      await Backendless.Data.of("Rooms").save({ roomCode });
      currentRoom = roomCode;
      startApp();
    };

    joinRoomBtn.onclick = async () => {
      const roomCode = roomInput.value.trim();
      if(!roomCode) return alert("Enter room code!");
      const rooms = await Backendless.Data.of("Rooms").find({ where: `roomCode='${roomCode}'` });
      if(rooms.length === 0) return alert("Room not found!");
      currentRoom = roomCode;
      startApp();
    };

    function startApp() {
      roomSection.style.display = "none";
      appDiv.style.display = "flex";
      initChat();
      initMovieSync();
      initVideoChat();
    }

    // Chat
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    async function initChat() {
      const chatRT = Backendless.Data.of("Messages").rt();
      chatRT.addCreateListener((msg) => {
        if(msg.room !== currentRoom) return;
        const div = document.createElement("div");
        div.textContent = `${msg.user}: ${msg.text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      sendBtn.onclick = async () => {
        const text = msgInput.value.trim();
        if(!text) return;
        await Backendless.Data.of("Messages").save({ user: currentUser.username, text, room: currentRoom });
        msgInput.value = "";
      };
    }

    // Movie sync
    const movie = document.getElementById("movie");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");

    async function initMovieSync() {
      const movieRT = Backendless.Data.of("MovieSync").rt();
      movieRT.addUpdateListener((data) => {
        if(data.room !== currentRoom) return;
        if(data.action === "play") movie.play();
        else if(data.action === "pause") movie.pause();
      });

      playBtn.onclick = async () => {
        movie.play();
        await Backendless.Data.of("MovieSync").save({ room: currentRoom, action: "play" });
      };
      pauseBtn.onclick = async () => {
        movie.pause();
        await Backendless.Data.of("MovieSync").save({ room: currentRoom, action: "pause" });
      };
    }

    // WebRTC Video Chat (Simple P2P)
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    let localStream, peerConnection;

    async function initVideoChat() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
      peerConnection = new RTCPeerConnection(servers);

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      // Use Backendless as signaling
      const signalTable = Backendless.Data.of("Signals");
      const signalsRT = signalTable.rt();
      signalsRT.addCreateListener(async (signal) => {
        if(signal.room !== currentRoom || signal.user === currentUser.username) return;
        if(signal.sdp) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.sdp));
          if(signal.sdp.type === "offer") {
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            await signalTable.save({ room: currentRoom, user: currentUser.username, sdp: answer });
          }
        } else if(signal.ice) {
          try { await peerConnection.addIceCandidate(signal.ice); } catch(e) {}
        }
      });

      peerConnection.onicecandidate = (event) => {
        if(event.candidate) {
          signalTable.save({ room: currentRoom, user: currentUser.username, ice: event.candidate });
        }
      };

      // Start connection if first user
      const existingSignals = await signalTable.find({ where: `room='${currentRoom}'` });
      if(existingSignals.length === 0) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        await signalTable.save({ room: currentRoom, user: currentUser.username, sdp: offer });
      }
    }
  </script>
</body>
</html>

